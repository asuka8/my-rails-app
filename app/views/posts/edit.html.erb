<div style="max-width: 600px; margin: 2rem auto; padding: 0 20px;">
  <div class="card" style="padding: 24px;">
    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 24px;">
      <%= link_to "⬅️", :back, style: "text-decoration: none; font-size: 1.2rem; color: var(--text-main);" %>
      <h2 style="margin: 0; font-size: 1.2rem; font-weight: 900;">投稿を編集</h2>
    </div>

    <%= form_with model: @post, local: true do |f| %>
      <%# テキストエリア %>
      <div style="margin-bottom: 20px;">
        <%= f.text_area :content, 
            style: "width: 100%; min-height: 120px; border: 1px solid var(--border-color); border-radius: 12px; padding: 12px; font-size: 1rem; outline: none; resize: vertical;",
            placeholder: "何を考えてる？" %>
      </div>

      <%# 画像管理エリア %>
      <div style="margin-bottom: 20px;">
        <label style="display: block; font-weight: bold; margin-bottom: 8px; color: var(--text-sub); font-size: 0.9rem;">
          画像を管理（複数選択可）
        </label>

        <%# 現在保存されている画像の一覧 %>
        <% if @post.images.attached? %>
          <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; padding: 10px; background: var(--bg-color); border-radius: 12px;">
            <% @post.images.each do |image| %>
              <div style="position: relative;">
                <%= image_tag image, style: "width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border-color);" %>
              </div>
            <% end %>
          </div>
          <p style="font-size: 0.75rem; color: var(--text-sub); margin-bottom: 15px;">※新しい画像を選択すると、追加で保存されます。</p>
        <% end %>

        <%# 新しい画像を追加するためのボタン %>
        <label style="display: inline-block; cursor: pointer; background: var(--bg-color); border: 2px dashed var(--border-color); border-radius: 12px; padding: 20px; width: 100%; text-align: center; transition: 0.2s;" 
               onmouseover="this.style.borderColor='var(--primary-color)'" 
               onmouseout="this.style.borderColor='var(--border-color)'">
          <span style="color: var(--primary-color); font-weight: bold;">＋ 新しい画像を追加</span>
          <%= f.file_field :images, multiple: true, accept: "image/*", id: "edit_post_images", style: "display: none;" %>
        </label>

        <%# 新しく選択した画像のプレビュー用コンテナ %>
        <div id="edit-image-preview" style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px;"></div>
      </div>

      <%# ボタンエリア %>
      <div style="display: flex; gap: 12px; margin-top: 30px;">
        <%= f.submit "変更を保存", class: "btn-primary", style: "flex: 2; padding: 12px;" %>
        <%= link_to "キャンセル", post_path(@post), style: "flex: 1; text-align: center; text-decoration: none; color: var(--text-sub); background: var(--bg-color); padding: 12px; border-radius: 999px; font-weight: bold; font-size: 0.95rem;" %>
      </div>
    <% end %>
  </div>
</div>

<script>
  // 編集画面用の画像プレビューJavaScript
  document.addEventListener('change', function(e) {
    if (e.target && e.target.id === 'edit_post_images') {
      const container = document.getElementById('edit-image-preview');
      container.innerHTML = '';
      const files = e.target.files;
      
      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(event) {
          const img = document.createElement('img');
          img.src = event.target.result;
          img.style.width = '70px';
          img.style.height = '70px';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '8px';
          img.style.border = '2px solid var(--primary-color)';
          container.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    }
  });
</script>