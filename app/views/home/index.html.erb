<div style="max-width: 600px; margin: 0 auto; border-left: 1px solid #eee; border-right: 1px solid #eee; background: white; min-height: 100vh;">

  <div style="padding: 20px; border-bottom: 1px solid #eee;">
    <%= form_with model: @post, local: true do |f| %>
      <div style="display: flex; gap: 10px;">
        <% if current_user.profile_image.attached? %>
          <%= image_tag current_user.profile_image, style: "width: 50px; height: 50px; border-radius: 50%; object-fit: cover;" %>
        <% end %>
        <div style="flex: 1;">
          <%= f.text_area :content, placeholder: "ã„ã¾ã©ã†ã—ã¦ã‚‹ï¼Ÿ", style: "width: 100%; border: none; font-size: 1.2rem; outline: none; resize: none;" %>
          
          <div id="image-preview" style="display: flex; gap: 5px; margin: 10px 0;"></div>

          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
            <label style="cursor: pointer; font-size: 1.5rem;">
              ğŸ–¼ï¸ <%= f.file_field :images, multiple: true, accept: "image/*", id: "post_images", style: "display: none;" %>
            </label>
            <%= f.submit "æŠ•ç¨¿ã™ã‚‹", style: "background: #1d9bf0; color: white; border: none; padding: 8px 20px; border-radius: 99px; font-weight: bold; cursor: pointer;" %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <% @posts.each do |post| %>
    <div style="padding: 15px; border-bottom: 1px solid #eee;">
      <div style="display: flex; gap: 10px;">
        <div style="width: 50px;">
          <% if post.user.profile_image.attached? %>
            <%= image_tag post.user.profile_image, style: "width: 50px; height: 50px; border-radius: 50%;" %>
          <% end %>
        </div>

        <div style="flex: 1;">
          <div style="display: flex; justify-content: space-between;">
            <strong><%= post.user.nickname.presence || post.user.email %></strong>
            <span style="color: #666; font-size: 0.8rem;"><%= time_ago_in_words(post.created_at) %>å‰</span>
          </div>
          
          <p style="white-space: pre-wrap; margin: 5px 0;"><%= render_with_hashtags(post.content) %></p>

          <% if post.images.attached? %>
            <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px;">
              <% post.images.each do |image| %>
                <%= image_tag image, style: "width: 48%; height: 150px; object-fit: cover; border-radius: 10px;" %>
              <% end %>
            </div>
          <% end %>

          <div style="display: flex; gap: 25px; margin-top: 15px; align-items: center;">
            
            <%# --- ã„ã„ã­ãƒœã‚¿ãƒ³å¾©æ´» --- %>
            <div style="display: flex; align-items: center; gap: 5px;">
              <% if post.user != current_user %>
                <% if post.likes.find_by(user_id: current_user.id) %>
                  <%= button_to post_likes_path(post), method: :delete, style: "background:none; border:none; cursor:pointer; padding:0; font-size: 1.1rem;" do %>
                    â¤ï¸
                  <% end %>
                <% else %>
                  <%= button_to post_likes_path(post), method: :post, style: "background:none; border:none; cursor:pointer; padding:0; font-size: 1.1rem;" do %>
                    ğŸ¤
                  <% end %>
                <% end %>
              <% else %>
                <span style="font-size: 1.1rem;">â¤ï¸</span>
              <% end %>
              <span style="font-size: 0.9rem; color: #666;"><%= post.likes.count %></span>
            </div>

            <%# ã‚³ãƒ¡ãƒ³ãƒˆãƒªãƒ³ã‚¯ %>
            <%= link_to post_path(post), style: "text-decoration: none; color: #666; display: flex; align-items: center; gap: 5px;" do %>
              <span style="font-size: 1.1rem;">ğŸ’¬</span>
              <span style="font-size: 0.9rem;"><%= post.comments.count %></span>
            <% end %>
            
            <%# è‡ªåˆ†ã®æŠ•ç¨¿ã®å ´åˆã®ã¿ã€Œç·¨é›†ãƒ»å‰Šé™¤ã€ %>
            <% if post.user == current_user %>
              <%= link_to "ç·¨é›†", edit_post_path(post), style: "text-decoration: none; color: #1d9bf0; font-size: 0.9rem; margin-left: 10px;" %>
              
              <%= link_to "å‰Šé™¤", post_path(post), 
                  data: { turbo_method: :delete, turbo_confirm: "æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ" }, 
                  style: "text-decoration: none; color: #f4212e; font-size: 0.9rem;" %>
            <% end %>

          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

<script>
  // turbo:load ã‚’ä½¿ã†å ´åˆã€ä»¥å‰ã®ãƒªã‚¹ãƒŠãƒ¼ãŒæ®‹ã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€
  // å‡¦ç†ã‚’ä¸€åº¦ã ã‘å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«é–¢æ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚
  (function() {
    const previewImages = function(e) {
      const container = document.getElementById('image-preview');
      if (!container) return;

      container.innerHTML = ''; // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆ
      const files = e.target.files;
      
      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(event) {
          const img = document.createElement('img');
          img.src = event.target.result;
          img.style = "width: 70px; height: 70px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd;";
          container.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    };

    // ãƒšãƒ¼ã‚¸é·ç§»ã®ãŸã³ã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†
    document.addEventListener("turbo:load", function() {
      const fileInput = document.getElementById('post_images');
      if (fileInput) {
        // äºŒé‡ç™»éŒ²ã‚’é˜²ããŸã‚ã€ä¸€åº¦å‰Šé™¤ã—ã¦ã‹ã‚‰ç™»éŒ²ã™ã‚‹
        fileInput.removeEventListener('change', previewImages);
        fileInput.addEventListener('change', previewImages);
      }
    });
  })();
</script>