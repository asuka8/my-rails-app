<!DOCTYPE html>
<html>
  <head>
    <title>MySNSApp</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>

    <style>
      body {
        margin: 0;
        background-color: #f5f8fa;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }

      /* ヘッダーナビゲーション */
      header {
        background-color: #fff;
        border-bottom: 1px solid #e1e8ed;
        padding: 12px 0;
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .nav-container {
        max-width: 600px;
        margin: 0 auto;
        display: flex;
        justify-content: space-around;
        align-items: center;
      }

      .nav-item {
        text-decoration: none;
        color: #66757f;
        font-weight: bold;
        position: relative;
        font-size: 0.95rem;
        transition: color 0.2s;
      }

      .nav-item:hover {
        color: #1da1f2;
      }

      /* 未読バッジのスタイル */
      .nav-badge {
        position: absolute;
        top: -8px;
        right: -15px;
        background-color: #1da1f2;
        color: white;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 10px;
        border: 2px solid white;
        font-weight: bold;
      }

      /* メインコンテンツの器 */
      .container {
        max-width: 600px;
        margin: 0 auto;
        background-color: #fff;
        min-height: 100vh;
        border-left: 1px solid #e1e8ed;
        border-right: 1px solid #e1e8ed;
      }

      /* 通知メッセージ */
      .alert {
        padding: 12px;
        text-align: center;
        color: white;
        font-size: 0.9rem;
      }
      .notice { background-color: #1da1f2; }
      .error { background-color: #e0245e; }

      .welcome-text {
        color: #1da1f2;
        font-weight: 900;
        font-size: 1.1rem;
      }
    </style>
  </head>

  <body>
    <header>
      <nav class="nav-container">
        <% if user_signed_in? %>
          <%# --- ログイン中のみ表示されるメニュー --- %>
          <%= link_to "ホーム", root_path, class: "nav-item" %>
          
          <%# 検索ボタンを削除しました %>

          <%# DM未読カウントの取得 %>
          <% 
            unread_count = Message.where(room_id: current_user.entries.pluck(:room_id))
                                  .where.not(user_id: current_user.id)
                                  .where(checked: false).count 
          %>
          
          <%= link_to rooms_path, class: "nav-item" do %>
            メッセージ
            <% if unread_count > 0 %>
              <span class="nav-badge"><%= unread_count %></span>
            <% end %>
          <% end %>

          <%= link_to "プロフィール", user_path(current_user), class: "nav-item" %>
          <%= link_to "ログアウト", destroy_user_session_path, data: { turbo_method: :delete }, class: "nav-item" %>
        
        <% else %>
          <%# --- 未ログイン（ログアウト中）のみ表示されるメニュー --- %>
          <div class="welcome-text">MySNSApp</div>
          <%= link_to "ログイン", new_user_session_path, class: "nav-item" %>
          <%= link_to "新規登録", new_user_registration_path, class: "nav-item" %>
        <% end %>
      </nav>
    </header>

    <% if notice %>
      <div class="alert notice"><%= notice %></div>
    <% end %>
    <% if alert %>
      <div class="alert error"><%= alert %></div>
    <% end %>

    <div class="container">
      <%= yield %>
    </div>
  </body>
</html>